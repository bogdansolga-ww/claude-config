#!/bin/bash

# Pre-push hook for TypeScript projects
# Runs type-check, lint, tests, and architecture checks in parallel
# Bypass with: git push --no-verify

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_error() { echo -e "${RED}x $1${NC}"; }
print_success() { echo -e "${GREEN}✓ $1${NC}"; }
print_warning() { echo -e "${YELLOW}! $1${NC}"; }
print_info() { echo "i $1"; }

# Skip in CI
if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ] || [ -n "$GITLAB_CI" ] || [ -n "$JENKINS_URL" ]; then
    print_warning "CI environment detected - skipping pre-push hook"
    exit 0
fi

# Detect package manager
detect_pm() {
    if [ -f "bun.lockb" ] || [ -f "bun.lock" ]; then echo "bun"
    elif [ -f "pnpm-lock.yaml" ]; then echo "pnpm"
    elif [ -f "yarn.lock" ]; then echo "yarn"
    else echo "npm"
    fi
}

# Check if script exists in package.json
has_script() {
    grep -q "\"$1\":" package.json 2>/dev/null
}

PM=$(detect_pm)

# Temp files
TYPE_LOG=$(mktemp)
LINT_LOG=$(mktemp)
TEST_LOG=$(mktemp)
SIZE_LOG=$(mktemp)
ARCH_LOG=$(mktemp)
SCHEMA_LOG=$(mktemp)
DEEP_ARCH_LOG=$(mktemp)
cleanup() { rm -f "$TYPE_LOG" "$LINT_LOG" "$TEST_LOG" "$SIZE_LOG" "$ARCH_LOG" "$SCHEMA_LOG" "$DEEP_ARCH_LOG"; }
trap cleanup EXIT

# Exit codes
TYPE_EXIT=0
LINT_EXIT=0
TEST_EXIT=0
ARCH_EXIT=0
SCHEMA_EXIT=0
DEEP_ARCH_EXIT=0

# File size thresholds (lines)
COMPONENT_LIMIT=400
SERVICE_LIMIT=500
UTILITY_LIMIT=300

echo "Running pre-push checks..."
echo "----------------------------------------"
echo ""

# Type check (background)
if has_script "type-check"; then
    {
        echo "[Type Check] Starting..."
        if $PM run type-check > "$TYPE_LOG" 2>&1; then
            echo "[Type Check] ✓ Passed"
        else
            echo "[Type Check] x Failed"
            exit 1
        fi
    } &
    TYPE_PID=$!
else
    TYPE_PID=""
fi

# Lint (background)
if has_script "lint"; then
    {
        echo "[Lint] Starting..."
        if $PM run lint > "$LINT_LOG" 2>&1; then
            echo "[Lint] ✓ Passed"
        else
            echo "[Lint] x Failed"
            exit 1
        fi
    } &
    LINT_PID=$!
else
    LINT_PID=""
fi

# Tests (background)
if has_script "test"; then
    {
        echo "[Tests] Starting..."
        if $PM run test --silent > "$TEST_LOG" 2>&1; then
            echo "[Tests] ✓ Passed"
        else
            echo "[Tests] x Failed"
            exit 1
        fi
    } &
    TEST_PID=$!
else
    TEST_PID=""
fi

# Architecture check (background)
if [ -f "./scripts/check-architecture.sh" ]; then
    {
        echo "[Architecture] Starting..."
        if ./scripts/check-architecture.sh > "$ARCH_LOG" 2>&1; then
            echo "[Architecture] ✓ Passed"
        else
            echo "[Architecture] x Failed"
            exit 1
        fi
    } &
    ARCH_PID=$!
else
    ARCH_PID=""
fi

# Schema check (background)
if [ -f "./scripts/check-schemas.sh" ]; then
    {
        echo "[Schema] Starting..."
        if ./scripts/check-schemas.sh > "$SCHEMA_LOG" 2>&1; then
            echo "[Schema] ✓ Passed"
        else
            echo "[Schema] x Failed"
            exit 1
        fi
    } &
    SCHEMA_PID=$!
else
    SCHEMA_PID=""
fi

# Deep architecture check (background)
if [ -f "./scripts/check-deep-architecture.sh" ]; then
    {
        echo "[Deep Arch] Starting..."
        if ./scripts/check-deep-architecture.sh > "$DEEP_ARCH_LOG" 2>&1; then
            echo "[Deep Arch] ✓ Passed"
        else
            if grep -q "error(s)" "$DEEP_ARCH_LOG"; then
                echo "[Deep Arch] x Failed"
                exit 1
            else
                echo "[Deep Arch] ✓ Passed (with warnings)"
            fi
        fi
    } &
    DEEP_ARCH_PID=$!
else
    DEEP_ARCH_PID=""
fi

# File size check (background, warning only)
{
    VIOLATIONS=0
    MERGE_BASE=$(git merge-base origin/master HEAD 2>/dev/null || git merge-base master HEAD 2>/dev/null || git merge-base origin/main HEAD 2>/dev/null || git merge-base main HEAD 2>/dev/null || echo "")

    if [ -n "$MERGE_BASE" ]; then
        FILES=$(git diff --name-only "$MERGE_BASE" HEAD 2>/dev/null || echo "")
    else
        FILES=$(git ls-files '*.ts' '*.tsx' 2>/dev/null || echo "")
    fi

    for file in $FILES; do
        [ ! -f "$file" ] && continue
        [[ ! "$file" =~ \.(ts|tsx)$ ]] && continue

        lines=$(wc -l < "$file")
        filename=$(basename "$file")

        if [[ "$filename" == *.service.ts ]]; then
            threshold=$SERVICE_LIMIT; type="service"
        elif [[ "$filename" == *.tsx ]]; then
            threshold=$COMPONENT_LIMIT; type="component"
        else
            threshold=$UTILITY_LIMIT; type="utility"
        fi

        if [ "$lines" -gt "$threshold" ]; then
            echo "$file: $lines lines ($type, limit: $threshold)" >> "$SIZE_LOG"
            VIOLATIONS=$((VIOLATIONS + 1))
        fi
    done

    if [ "$VIOLATIONS" -gt 0 ]; then
        echo "[File Size] ! Warning ($VIOLATIONS files exceed limits)"
    else
        echo "[File Size] ✓ Passed"
    fi
} &
SIZE_PID=$!

# Wait for results
[ -n "$TYPE_PID" ] && { wait $TYPE_PID || TYPE_EXIT=1; }
[ -n "$LINT_PID" ] && { wait $LINT_PID || LINT_EXIT=1; }
[ -n "$TEST_PID" ] && { wait $TEST_PID || TEST_EXIT=1; }
[ -n "$ARCH_PID" ] && { wait $ARCH_PID || ARCH_EXIT=1; }
[ -n "$SCHEMA_PID" ] && { wait $SCHEMA_PID || SCHEMA_EXIT=1; }
[ -n "$DEEP_ARCH_PID" ] && { wait $DEEP_ARCH_PID || DEEP_ARCH_EXIT=1; }
wait $SIZE_PID

echo ""
echo "----------------------------------------"
echo "Results:"
echo ""

# Display results
if [ -n "$TYPE_PID" ]; then
    if [ $TYPE_EXIT -eq 0 ]; then
        print_success "Type Check: Passed"
    else
        print_error "Type Check: Failed"
        tail -15 "$TYPE_LOG" | sed 's/^/  /'
    fi
    echo ""
fi

if [ -n "$LINT_PID" ]; then
    if [ $LINT_EXIT -eq 0 ]; then
        print_success "Lint: Passed"
    else
        print_error "Lint: Failed"
        tail -15 "$LINT_LOG" | sed 's/^/  /'
    fi
    echo ""
fi

if [ -n "$TEST_PID" ]; then
    if [ $TEST_EXIT -eq 0 ]; then
        print_success "Tests: Passed"
        grep -E "Test Files.*passed|Tests.*passed|✓" "$TEST_LOG" | head -2 | sed 's/^/  /' || true
    else
        print_error "Tests: Failed"
        tail -20 "$TEST_LOG" | sed 's/^/  /'
    fi
    echo ""
fi

if [ -n "$ARCH_PID" ]; then
    if [ $ARCH_EXIT -eq 0 ]; then
        print_success "Architecture: Passed"
    else
        print_error "Architecture: Failed"
        grep -v "^Checking\|^$" "$ARCH_LOG" | head -10 | sed 's/^/  /'
    fi
    echo ""
fi

if [ -n "$SCHEMA_PID" ]; then
    if [ $SCHEMA_EXIT -eq 0 ]; then
        print_success "Schema: Passed"
    else
        print_error "Schema: Failed"
        grep -v "^Checking\|^$" "$SCHEMA_LOG" | head -10 | sed 's/^/  /'
    fi
    echo ""
fi

if [ -n "$DEEP_ARCH_PID" ]; then
    if [ $DEEP_ARCH_EXIT -eq 0 ]; then
        print_success "Deep Architecture: Passed"
    else
        print_error "Deep Architecture: Failed"
        grep -E "^(✗|  -)" "$DEEP_ARCH_LOG" | head -10 | sed 's/^/  /'
    fi
    echo ""
fi

# File size warnings
if [ -s "$SIZE_LOG" ]; then
    print_warning "File Size: Large files detected"
    cat "$SIZE_LOG" | sed 's/^/  /'
    echo ""
else
    print_success "File Size: Passed"
    echo ""
fi

echo "----------------------------------------"

# Final check
if [ $TYPE_EXIT -ne 0 ] || [ $LINT_EXIT -ne 0 ] || [ $TEST_EXIT -ne 0 ] || [ $ARCH_EXIT -ne 0 ] || [ $SCHEMA_EXIT -ne 0 ] || [ $DEEP_ARCH_EXIT -ne 0 ]; then
    print_error "Pre-push checks failed!"
    echo ""
    echo "Bypass with: git push --no-verify"
    exit 1
else
    print_success "All pre-push checks passed!"
    exit 0
fi
