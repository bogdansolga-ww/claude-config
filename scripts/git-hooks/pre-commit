#!/bin/bash

# Pre-commit hook for TypeScript projects
# Runs type-check, lint, and architecture checks on staged files
# Bypass with: git commit --no-verify

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_error() { echo -e "${RED}x $1${NC}"; }
print_success() { echo -e "${GREEN}✓ $1${NC}"; }
print_warning() { echo -e "${YELLOW}! $1${NC}"; }
print_info() { echo "i $1"; }

# Detect package manager
detect_pm() {
    if [ -f "bun.lockb" ] || [ -f "bun.lock" ]; then echo "bun"
    elif [ -f "pnpm-lock.yaml" ]; then echo "pnpm"
    elif [ -f "yarn.lock" ]; then echo "yarn"
    else echo "npm"
    fi
}

# Check if script exists in package.json
has_script() {
    grep -q "\"$1\":" package.json 2>/dev/null
}

PM=$(detect_pm)
CHECKS_FAILED=0
CHECK_NUM=0
TOTAL_CHECKS=0

# Count total checks
has_script "type-check" && TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
has_script "lint" && TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
[ -f "./scripts/check-architecture.sh" ] && TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
[ -f "./scripts/check-schemas.sh" ] && TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
[ -f "./scripts/check-deep-architecture.sh" ] && TOTAL_CHECKS=$((TOTAL_CHECKS + 1))

# Get staged TS/JS files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
    print_info "No TypeScript/JavaScript files staged, skipping checks"
    exit 0
fi

echo "Running pre-commit checks..."
echo ""

# Type check
if has_script "type-check"; then
    CHECK_NUM=$((CHECK_NUM + 1))
    echo "$CHECK_NUM/$TOTAL_CHECKS  Running TypeScript type check..."
    if $PM run type-check --silent 2>&1 | tee /tmp/tsc-output.txt > /dev/null; then
        print_success "Type check passed"
    else
        PROD_ERRORS=$(grep -E "^src/.*(error TS)" /tmp/tsc-output.txt 2>/dev/null || true)
        if [ -n "$PROD_ERRORS" ]; then
            print_error "TypeScript errors in production code"
            echo "$PROD_ERRORS" | head -10 | sed 's/^/    /'
            CHECKS_FAILED=1
        else
            print_success "Type check passed (test errors ignored)"
        fi
    fi
    echo ""
fi

# Lint
if has_script "lint"; then
    CHECK_NUM=$((CHECK_NUM + 1))
    echo "$CHECK_NUM/$TOTAL_CHECKS  Running linter..."
    if $PM run lint --silent 2>&1 | tee /tmp/lint-output.txt > /dev/null; then
        print_success "Lint passed"
    else
        print_error "Lint errors found"
        tail -15 /tmp/lint-output.txt | sed 's/^/    /'
        CHECKS_FAILED=1
    fi
    echo ""
fi

# Architecture hierarchy check
if [ -f "./scripts/check-architecture.sh" ]; then
    CHECK_NUM=$((CHECK_NUM + 1))
    echo "$CHECK_NUM/$TOTAL_CHECKS  Checking architecture hierarchy..."
    if ./scripts/check-architecture.sh --staged > /tmp/arch-output.txt 2>&1; then
        print_success "Architecture hierarchy check passed"
    else
        print_error "Architecture hierarchy violations found"
        grep -v "^Checking\|^$" /tmp/arch-output.txt | head -10 | sed 's/^/    /'
        CHECKS_FAILED=1
    fi
    echo ""
fi

# Schema location check
if [ -f "./scripts/check-schemas.sh" ]; then
    CHECK_NUM=$((CHECK_NUM + 1))
    echo "$CHECK_NUM/$TOTAL_CHECKS  Checking schema locations..."
    if ./scripts/check-schemas.sh --staged > /tmp/schema-output.txt 2>&1; then
        print_success "Schema location check passed"
    else
        print_error "Inline schema violations found"
        grep -v "^Checking\|^$" /tmp/schema-output.txt | head -10 | sed 's/^/    /'
        CHECKS_FAILED=1
    fi
    echo ""
fi

# Deep architecture check
if [ -f "./scripts/check-deep-architecture.sh" ]; then
    CHECK_NUM=$((CHECK_NUM + 1))
    echo "$CHECK_NUM/$TOTAL_CHECKS  Running deep architecture checks..."
    if ./scripts/check-deep-architecture.sh > /tmp/deep-arch-output.txt 2>&1; then
        print_success "Deep architecture check passed"
    else
        if grep -q "error(s)" /tmp/deep-arch-output.txt; then
            print_error "Deep architecture violations found"
            grep -E "^(✗|  -)" /tmp/deep-arch-output.txt | head -10 | sed 's/^/    /'
            CHECKS_FAILED=1
        else
            print_success "Deep architecture check passed"
            print_warning "Note: Some warnings found (not blocking)"
        fi
    fi
    echo ""
fi

# Summary
echo "----------------------------------------"
if [ $CHECKS_FAILED -eq 1 ]; then
    print_error "Pre-commit checks failed!"
    echo ""
    echo "Bypass with: git commit --no-verify"
    exit 1
else
    print_success "All pre-commit checks passed!"
    exit 0
fi
